$(document).ready(function(){return d3.csv("ly.csv",function(n,e){function t(n,e){return i.indexOf(n.session)-i.indexOf(e.session)}var s,r,i,o,u,c,l,a,f,g,d,h,p,y,x,v,A,w,k,m,Y,b,O,j,q,z,B,C,D,E,F,G,H,I,J,K,L,M,N,P;for(s={},r={},i="一二三四五六七八九",o=[],u=[],c={},l={},a={},f={},g=0,d=e.length;d>g;++g)h=e[g],p=/第(.)屆 ?[(（](.+)[）)]/.exec(h["屆數"]),y=+p[2],x=h["參選年齡"],h["出生年次"]||(!h.guessYear||y-x<h.guessYear)&&(h.guessYear=y-x);for(g=0,d=e.length;d>g;++g)h=e[g],v=h["姓名"],null==f[v]&&(f[v]={count:0,list:[],src:h}),f[v].count++,p=/第(.)屆 ?[(（](.+)[）)]/.exec(h["屆數"]),A=i.indexOf(p[1]),y=+p[2],x=y-(+h["出生年次"]||h.guessYear),w=h["推薦政黨"],l[A]=1,a[x]=1,c[w]=1,f[v].list.push(k={session:A,age:x,party:w,src:f[v]}),u.push(k);for(m in f)for(Y=f[m],Y.list.sort(t),g=0,b=Y.list.length-1;b>g;++g)h=g,o.push([Y.list[h],Y.list[h+1]]);for(g=0,d=o.length;d>g;++g)for(O=o[g],null==s[O[0].session]&&(s[O[0].session]={count:0,session:O[0].session}),s[O[0].session].count++,j=O[0].age+1,b=O[1].age;b>j;++j)h=j,null==r[h]&&(r[h]={count:0,age:h}),r[h].count++;for(g=0,d=u.length;d>g;++g)k=u[g],h=k.age,null==r[h]&&(r[h]={count:0,age:h}),r[h].count++;q=[];for(m in l)q.push(+m);l=q,q=[];for(m in a)q.push(+m);a=q,q=[];for(m in c)q.push(m);c=q,a.sort(),c.sort(),l.sort(),q=[];for(m in r)Y=r[m],q.push(Y);z=q,B=d3.select("#svg").selectAll("rect.age").data(z),B.enter().append("rect").attr({"class":"age"}),q=[];for(m in s)Y=s[m],q.push(Y);return C=q,D=d3.select("#svg").selectAll("rect.session").data(C),D.enter().append("rect").attr({"class":"session"}),E=d3.select("#svg").selectAll("circle").data(u),E.enter().append("circle").on("click",function(n){return console.log(n)}),F=d3.select("#svg").selectAll("line").data(o),F.enter().append("line").on("click",function(n){return console.log(n)}),G=$("#svg").width(),H=$("#svg").height(),I=20,J=d3.scale.linear().domain([0,10]).range([I,G-I]),K=d3.scale.linear().domain([20,40]).range([H-I,I]),L=d3.scale.ordinal().domain(c).range(["#44f","#999","#dd0","#4f8","#bbb","#f90"]),M=function(){return d3.selectAll("line").transition().duration(1e3).attr({x1:function(n){return 0===N?J(1)-10+10*n[0].session:J(n[0].session)},x2:function(n){return 0===N?J(1)-10+10*n[0].session:J(n[1].session)},y1:function(n){return 2===N?K(22)-n[0].age:K(n[0].age)},y2:function(n){return 2===N?K(22)-n[0].age:K(n[1].age)},stroke:function(n){return L(n[0].party)},"stroke-width":function(){return 1!==N?10:2},opacity:function(){return 1!==N?0:1}}),d3.selectAll("circle").transition().duration(1e3).attr({cx:function(n){return J(0===N?1:n.session)},cy:function(n){return K(2===N?22:n.age)},r:5,fill:function(n){return L(n.party)},opacity:function(){return 1!==N?0:1}}),d3.selectAll("rect.age").transition().duration(1e3).attr({x:function(){return J(1)-10},y:function(n){return K(n.age)-(K(n.age)-K(n.age+1))/2},width:function(n){return 0===N?4*n.count:0},height:function(n){return K(n.age)-K(n.age+1)},fill:"#999",opacity:function(){return 0===N?1:0}}),d3.selectAll("rect.session").transition().duration(1e3).attr({x:function(n){return J(n.session)},y:function(n){return 2===N?K(22)-10*n.count:K(22)},width:function(n){return J(n.session+1)-J(n.session)},height:function(n){return 2===N?10*n.count:0},fill:"#999",opacity:function(){return 2===N?1:0}})},N=0,M(),P=1,window.toggle=function(){return N+=P,N>=2&&(P=-1),0>=N&&(P=1),M()}})});